# -*- coding: utf-8 -*-

begin
  require 'rubygems'
  require 'bundler/setup'
rescue LoadError
end
$:.unshift 'lib'

require 'rake/clean'
require 'dcmgr'

task :environment do
  Dcmgr.configure 'dcmgr.conf'
  Dcmgr.run_initializers
end

namespace :db do
  desc 'Create all database tables'
  task :init => [ :environment ] do
    ::Kernel.load(File.expand_path('../conf/initializers/sequel.rb', __FILE__))
    require 'isono'
    
    Dcmgr::Models::CREATE_TABLE_CLASSES.each { |c|
      Dcmgr::Models.const_get(c).create_table!
    }
    Isono::Models::NodeState.create_table!
    Isono::Models::JobState.create_table!

    Dcmgr::Models::CREATE_TABLE_CLASSES.each { |c|
      Dcmgr::Models.const_get(c).install_data
    }
  end

  desc 'Drop all database tables'
  task :drop => [ :environment ] do
    require 'sequel'
    require 'isono'
    
    Dcmgr::Models::CREATE_TABLE_CLASSES.each { |c|
      Dcmgr::Models.const_get(c).drop_table
    }
    Isono::Models::NodeState.drop_table
    Isono::Models::JobState.drop_table
  end
end

desc 'run bundle command to install vendored gems.'
task :bundle do
  sh <<_ENDCMD
mkdir .bundle
cat <<END_ > .bundle/config
---
BUNDLE_DISABLE_SHARED_GEMS: "1"
BUNDLE_PATH: vendor/bundle
END_
_ENDCMD
  sh "bundle install"
end

