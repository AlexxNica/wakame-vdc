# -*- coding: utf-8 -*-

$:.unshift 'lib'

require 'dcmgr/rubygems'

require 'rake/clean'
CLOBBER.include("vendor/bundle/**/*", "*.gem")

task :environment do
  require 'dcmgr'
  Dcmgr.load_conf(Dcmgr::Configurations::Dcmgr,
                  ['/etc/wakame-vdc/dcmgr.conf',
                   File.expand_path('config/dcmgr.conf', Dcmgr::DCMGR_ROOT)
                  ])
end

namespace :db do
  desc 'Up all database migrations'
  task :up => [ :environment ] do
    Dcmgr.run_initializers('logger', 'sequel')

    Sequel.extension :migration
    Sequel::Migrator.apply(Sequel::DATABASES.first, File.expand_path('../config/db/migrations', __FILE__), 9999)
  end

  desc 'Down all database migrations'
  task :down => [ :environment ] do
    Dcmgr.run_initializers('logger', 'sequel')

    Sequel.extension :migration
    Sequel::Migrator.apply(Sequel::DATABASES.first, File.expand_path('../config/db/migrations', __FILE__), 0)
  end

  task :init => [:up] do
    STDERR.puts "WARN: deprecated task. Please use db:up."
  end

  task :drop => [:down] do
    STDERR.puts "WARN: deprecated task. Please use db:down."
  end
end

desc 'run bundle command to install vendored gems.'
task :bundle do
  sh <<_ENDCMD
mkdir .bundle
cat <<END_ > .bundle/config
---
BUNDLE_DISABLE_SHARED_GEMS: "1"
BUNDLE_PATH: vendor/bundle
END_
_ENDCMD
  sh "bundle install"
end
