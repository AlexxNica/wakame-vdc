#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'dcmgr/rubygems'
require 'dcmgr'
require 'isono'

include Isono::Runner::RpcServer

manifest = Isono::Runner::RpcServer::DEFAULT_MANIFEST.dup
manifest.instance_eval do
  node_name 'sta'
  node_instance_id "#{Isono::Util.default_gw_ipaddr}"

  load_module Isono::NodeModules::NodeHeartbeat
  load_module Dcmgr::NodeModules::StaTgtInitializer

  config do |c| 
    c.iqn_prefix = 'iqn.2010-09.jp.wakame'
    c.initiator_address = 'ALL'
    c.backing_store = 'tgt'
    c.iscsi_target = 'linux_iscsi'
    c.start_command = "initctl start tgt"
    c.stop_command = "initctl stop tgt"
  end 

  load_config File.expand_path('config/sta.conf', app_root)
end

start(manifest) do
  endpoint "sta-handle.#{@node.node_id}", Dcmgr::Rpc::StaHandler
end
