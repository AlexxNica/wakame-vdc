# -*- coding: utf-8 -*-
require 'isono'

module Dcmgr
  module NodeModules
    class MetricCollector < Isono::NodeModules::Base
      include Isono::NodeModules
      include Dcmgr::Logger

      initialize_hook do
        rpc = RpcChannel.new(node)
        app = Isono::Rack::ObjectMethod.new(myinstance)
        rpc.register_endpoint('metric-collector', Isono::Rack.build do
            use Isono::Rack::DataStore
            run proc { |req, res|
              Thread.current[Models::BaseNew::LOCK_TABLES_KEY] = {}
              app.call(req, res)
            }
          end)
      end

      terminate_hook do
      end

      def get_alarm_data(instance_ids)
        raise ArgumentError unless instance_ids.is_a?(Array)
        logger.debug(instance_ids)
        alarms = Models::Alarm.filter(:resource_id => instance_ids).all.map { |alarm|
          alarm.to_hash
        }
        alarms
      end
      
      def register_metric(instance_id, data)
        logger.info("#{instance_id}: #{data}")
        # do not respond model object.
        nil
      end
    end
  end
end
