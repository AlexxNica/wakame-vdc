# -*- coding: utf-8 -*-

module Dcmgr::NodeModules
  class SGHandler < Isono::NodeModules::Base
    include Dcmgr::Logger
    M = Dcmgr::Models

    initialize_hook do
      app = Isono::Rack::ObjectMethod.new(myinstance)
      job = Isono::NodeModules::JobChannel.new(node)
      job.register_endpoint('sg_handler', Isono::Rack.build do
        use Isono::Rack::Sequel
        run proc { |req, res|
          Thread.current[M::BaseNew::LOCK_TABLES_KEY] = {}
          app.call(req, res)
        }
      end)
    end

    def init_vnic(vnic_id)
      #TODO: Nilchecks for instance and host node
      host_node = M::NetworkVif[vnic_id].instance.host_node
      tasks = []
      logger.info "Telling host '#{host_node.canonical_uuid}' to initialize vnic '#{vnic_id}'."
      call_packetfilter_service(host_node,"init_vnic",vnic_id,tasks)
    end

    def add_sgs_to_vnic(vnic_id,sg_uuids)
      #TODO: Check if we're already in any of these sgs... log warning if we are
      logger.info "Adding security groups '#{sg_uuids.join(",")}' to vnic: '#{vnic_id}'."
    end

    def remove_sgs_from_vnic(vnic_id,sg_uuids)
      #TODO: Check if we are in these sgs... log warning if we aren't
      logger.info "Removing security groups '#{sg_uuids.join(",")}' from vnic: '#{vnic_id}'."
    end

    def destroy_vnic(vnic_id)
      host_node = M::NetworkVif[vnic_id].instance.host_node
      logger.info "Telling host '#{host_node.canonical_uuid}' to destroy vnic '#{vnic_id}'."
      call_packetfilter_service(host_node,"destroy_vnic",vnic_id)
    end

    private
    def call_packetfilter_service(host_node,method,*args)
      # Dcmgr.messaging.submit(host_node,method,*args)
      event.publish("#{host_node[:node_id]}-#{method}",:args => args)
    end

    def event
      @event ||= Isono::NodeModules::EventChannel.new(@node)
    end

  end
end
