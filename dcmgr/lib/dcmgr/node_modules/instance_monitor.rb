# -*- coding: utf-8 -*-
module Dcmgr
  module NodeModules
    class InstanceMonitor < Isono::NodeModules::Base
      include Dcmgr::Logger

      initialize_hook do
        @thread_pool = Isono::ThreadPool.new(1, 'InstanceMonitor')
        @monitor = EventMachine::PeriodicTimer.new(5) {
          next if @thread_pool.queue.size > 0
          @thread_pool.pass {
            myinstance.dup.check_instance
          }
        }
      end

      terminate_hook do
        @monitor.cancel
        @thread_pool.shutdown
      end

      # Reset TaskSession per request.
      def task_session
        @task_session ||= begin
                            Task::TaskSession.reset!(:thread)
                            Task::TaskSession.current
                          end
      end

      
      def check_instance()
        instlst = rpc.request('hva-collector', 'get_instance_monitor_data', manifest.node_id)
        instlst.each { |i|
          begin
            task_session.invoke(Dcmgr::Drivers::Hypervisor.driver_class(i[:hypervisor]),
                                :check_instance, [i[:uuid]])
          rescue Exception => e
            if i[:status] == 'online'
              logger.error("#{e.class}, #{e.message}")

              rpc.request('hva-collector', 'update_instance', i[:uuid], {:status=>:offline}) { |req|
                req.oneshot = true
              }
              event.publish('hva/fault_instance', :args=>[i[:uuid]])
            end
            next
          end

          if i[:status] != 'online'
            rpc.request('hva-collector', 'update_instance', i[:uuid], {:status=>:online}) { |req|
              req.oneshot = true
            }
          end
        }
      end

      def rpc
        @rpc ||= Isono::NodeModules::RpcChannel.new(@node)
      end

      def event
        @event ||= Isono::NodeModules::EventChannel.new(@node)
      end
    end

  end
end
