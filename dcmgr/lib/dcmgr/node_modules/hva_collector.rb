# -*- coding: utf-8 -*-
require 'isono'

module Dcmgr
  module NodeModules
    class HvaCollector < Isono::NodeModules::Base
      include Isono::NodeModules

      initialize_hook do
        rpc = RpcChannel.new(node)
        app = Isono::Rack::ObjectMethod.new(myinstance)
        rpc.register_endpoint('hva-collector', Isono::Rack.build do
                                use Isono::Rack::DataStore
                                run app
                              end)
      end

      terminate_hook do
      end

      def get_instance(instance_id)
        inst = Models::Instance[instance_id]
        raise "UnknownInstanceID" if inst.nil?

        ret = inst.to_hash
        ret
      end

      def update_instance(instance_id, data)
        inst = Models::Instance[instance_id]
        inst.set_fields(data, [:state]).save
        # do not respond model object.
        nil
      end

      def get_netfilter_groups_of_instance(instance_id)
        inst = Models::Instance[instance_id]
        inst.netfilter_groups.map { |g| g.to_hash }
      end

      def get_group_instance_ipv4s(instance_id)
        insts = Models::Instance[instance_id].netfilter_group_instances
        ips = insts.map { |instance|
          instance.ips.map { |ip| ip.ipv4 }
        }
        ips.flatten!
      end

      def get_dhcp_conf()
        Models::IpLease.all.map { |ip|
          {:mac_addr=>ip.instance_nic.pretty_mac_addr,
            :ipaddr => ip.ipv4
          }
        }
      end
      
    end
  end
end
