# -*- coding: utf-8 -*-
require 'isono'

module Dcmgr
  module NodeModules
    class HvaCollector < Isono::NodeModules::Base
      include Isono::NodeModules

      initialize_hook do
        rpc = RpcChannel.new(node)
        app = Isono::Rack::ObjectMethod.new(myinstance)
        rpc.register_endpoint('hva-collector', Isono::Rack.build do
                                use Isono::Rack::DataStore
                                run app
                              end)
      end

      terminate_hook do
      end

      def get_instance(instance_id)
        inst = Models::Instance[instance_id]
        raise "UnknownInstanceID" if inst.nil?

        ret = inst.to_hash
        ret
      end

      def update_instance(instance_id, data)
        inst = Models::Instance[instance_id]
        inst.set_fields(data, [:state]).save
        # do not respond model object.
        nil
      end

      def get_netfilter_groups_of_instance(instance_id)
        inst = Models::Instance[instance_id]
        raise "UnknownInstanceID" if inst.nil?

        inst.netfilter_groups.map { |g| g.to_hash }
      end

      def get_group_instance_ipv4s(instance_id)
        inst = Models::Instance[instance_id]
        raise "UnknownInstanceID" if inst.nil?

        insts = inst.netfilter_group_instances
        ips = insts.map { |instance|
          instance.ips.map { |ip| ip.ipv4 }
        }

        ips.flatten! if ips.size > 0
        ips
      end

      def get_dhcp_conf()
        network = Models::Network.all.first
        h = {
          :ipv4_gw=>network.ipv4_gw,
          :netmask => network.netmask,
          :dns_server=> '192.168.1.25',
          :domain_name => 'vdc.local',
          :mac2addr => [],
          :addr2host=> [],
        }
        
        h[:mac2addr] = network.ip_lease.map { |ip|
          {:mac_addr=>ip.instance_nic.pretty_mac_addr,
            :ipaddr => ip.ipv4
          }
        }

        h
      end
      
    end
  end
end
