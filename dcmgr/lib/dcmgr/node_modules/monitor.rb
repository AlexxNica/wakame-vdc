# -*- coding: utf-8 -*-
require 'metric_libs'

module Dcmgr
  module NodeModules
    class Monitor < Isono::NodeModules::Base
      include Dcmgr::Logger
      include Dcmgr::Helpers
      include Dcmgr::Monitor

      initialize_hook do
        @alarm_manager = MetricLibs::AlarmManager.new(EmTimer.new)
        @resource_capture = ResourceCapture.new(node)

        EM.defer do
          myinstance.initialize_alarm_from_database
        end

        logger.info("Resource monitor start")
        EM.add_periodic_timer(5) do
          EM.defer do
            resources = @resource_capture.get_resources
            @alarm_manager.update_resources(resources)
          end
        end

        job = Isono::NodeModules::JobChannel.new(node)
        app = Isono::Rack::ObjectMethod.new(myinstance)
        job.register_endpoint("resource-alarm-registry.#{node.node_id}",
          Isono::Rack.build do
            run proc {|req, res|
              app.call(req, res)
            }
          end)
      end

      terminate_hook do
      end

      def update_alarm(alarm_id)
        alm = get_alarm(alarm_id)
        logger.info("Update alarm: #{alm[:uuid]}")
        EM.next_tick do
          @alarm_manager.update(alm)
        end
      end

      def delete_alarm(alarm_id)
        alm = get_alarm(alarm_id)
        logger.info("Remove alarm: #{alm[:uuid]}")
        EM.next_tick do
          @alarm_manager.delete(alm)
        end
      end

      def get_alarm(alm_id)
        raise ArgumentError unless alm_id.is_a?(String)
        rpc.request('alarm-collector', 'get_alarm', alm_id)
      end

      def initialize_alarm_from_database
        logger.info("Initialize alarm from database")
        # TODO: add volume and network vif
        instance_ids = rpc.request('hva-collector', 'get_metric_monitor_instance_ids', node.node_id)
        alarms = rpc.request('alarm-collector', 'get_resource_alarms', instance_ids)
        logger.info("Update alarms: #{alarms}")
        @alarm_manager.updates(alarms)
      end

      private
      def rpc
        @rpc ||= Isono::NodeModules::RpcChannel.new(@node)
      end

    end

    class EmTimer < MetricLibs::Timer
      include Dcmgr::Logger

      def cancel
        @timer.cancel
      end

      def add_periodic_timer(alm)
        @timer = EM::PeriodicTimer.new(alm.instance_variable_get(:@evaluation_periods)) do
          logger.info("Evaluation: #{alm.instance_variable_get(:@metric_name)}")
          if alm.evaluate
            # TODO: Notification.
          end
        end
      end
    end

    class Notification
      def initialize
      end
    end

  end
end
